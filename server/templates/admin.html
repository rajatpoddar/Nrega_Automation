<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>License Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 2em; background: #f8f9fa; color: #343a40; }
        .container { max-width: 1200px; margin: auto; } .card { margin-bottom: 2em; padding: 1.5em; background: #fff; border: 1px solid #dee2e6; border-radius: 0.5rem; }
        .btn { color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 0.25rem; font-weight: 500; text-decoration: none; display: inline-block; margin-top: 4px; }
        .btn-primary { background: #007bff; } .btn-secondary { background: #6c757d; } .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; } .btn-warning { background: #ffc107; color: #212529; } .btn-info { background: #17a2b8; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; } th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; } .key-cell { display: flex; justify-content: space-between; align-items: center; }
        .key { font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px; }
        .copy-btn { font-size: 0.8em; padding: 4px 8px; }
        .tag { padding: 4px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .tag-paid { background: #28a745; color: white; } .tag-trial { background: #ffc107; color: #212529; } .tag-blocked { background: #dc3545; color: white; }
        .flash { padding: 1em; margin-bottom: 1em; border-radius: .25rem; } .flash-success { background: #d4edda; color: #155724; } .flash-error { background: #f8d7da; color: #721c24; }
    </style>
    <script>
        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => { alert('Copied: ' + key); });
        }
        function confirmReset(form) {
            if (confirm("Are you sure you want to reset the machine binding for this key? This will allow it to be activated on a new device.")) {
                form.submit();
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>NREGA Dashboard - License Admin</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="card">
            <h2>Generate New License Key</h2>
            <form action="/generate" method="post" style="display:inline-block; margin-right: 1em;"><input type="hidden" name="duration" value="monthly"><input type="submit" class="btn btn-primary" value="Generate Monthly Key"></form>
            <form action="/generate" method="post" style="display:inline-block;"><input type="hidden" name="duration" value="yearly"><input type="submit" class="btn btn-success" value="Generate Yearly Key"></form>
        </div>
        <div class="card">
            <h2>Database Management</h2>
            <a href="/export" class="btn btn-secondary">Export Keys to CSV</a>
            <form action="/import" method="post" enctype="multipart/form-data" style="display:inline-block; margin-left: 1em;">
                <input type="file" name="file" accept=".csv">
                <input type="submit" class="btn btn-warning" value="Import Keys from CSV">
            </form>
        </div>
        <div class="card">
            <h2>Existing Licenses</h2>
            <table>
                <tr><th>License Key</th><th>Type</th><th>Machine ID</th><th>Expires On</th><th>Status</th><th>Actions</th></tr>
                {% for license in licenses %}
                <tr>
                    <td class="key-cell"><span class="key">{{ license['key'] }}</span><button class="btn btn-secondary copy-btn" onclick="copyKey('{{ license['key'] }}')">Copy</button></td>
                    <td><span class="tag {{ 'tag-paid' if license['key_type'] == 'paid' else 'tag-trial' }}">{{ license['key_type'] | capitalize }}</span></td>
                    <td>{{ license['machine_id'] or 'N/A' }}</td>
                    <td>{{ license['expires_at'].split('T')[0] }}</td>
                    <td>{% if license['is_blocked'] %} <span class="tag tag-blocked">Blocked</span> {% else %} <span class="tag tag-paid">Active</span> {% endif %}</td>
                    <td>
                        <form action="/admin-action" method="post" style="display:inline;"><input type="hidden" name="key" value="{{ license['key'] }}"><input type="hidden" name="action" value="extend"><input type="submit" class="btn btn-secondary" value="Extend 30 Days"></form>
                        {% if license['is_blocked'] %}
                            <form action="/admin-action" method="post" style="display:inline;"><input type="hidden" name="key" value="{{ license['key'] }}"><input type="hidden" name="action" value="unblock"><input type="submit" class="btn btn-warning" value="Unblock"></form>
                        {% else %}
                            <form action="/admin-action" method="post" style="display:inline;"><input type="hidden" name="key" value="{{ license['key'] }}"><input type="hidden" name="action" value="block"><input type="submit" class="btn btn-danger" value="Block"></form>
                        {% endif %}
                        {% if license['machine_id'] %}
                            <form action="/admin-action" method="post" style="display:inline;" onsubmit="event.preventDefault(); confirmReset(this);">
                                <input type="hidden" name="key" value="{{ license['key'] }}">
                                <input type="hidden" name="action" value="reset_machine">
                                <input type="submit" class="btn btn-info" value="Reset Machine">
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</body>
</html>