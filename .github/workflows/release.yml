# .github/workflows/release.yml
name: Create Application Release

on:
  push:
    branches:
      - main   # runs automatically on every push to main
  workflow_dispatch: {} # still allows manual trigger if needed

jobs:
  # Extract version & changelog
  get-release-info:
    name: Get Release Information
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag: v${{ steps.get_version.outputs.version }}
      changelog: ${{ steps.get_changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get version from version.json
        id: get_version
        run: |
          VERSION=$(jq -r '.latest_version' version.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get changelog for the version
        id: get_changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          CHANGELOG_BODY=$(jq -r --arg VERSION "$VERSION" '.changelog[$VERSION] | .[] | "- \(.)"' version.json)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


  # --- Build Job for Windows ---
  build-windows:
    name: Build for Windows
    needs: get-release-info
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env
        shell: bash

      - name: Run Windows build script
        run: |
          set APP_VERSION=${{ needs.get-release-info.outputs.version }}
          build_windows.bat
        shell: cmd


      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            dist/installer/*.exe
            dist/NREGABot-v${{ needs.get-release-info.outputs.version }}-Windows-Portable.zip
      

      - name: Create Portable ZIP archive
        run: |
          $version = "${{ needs.get-release-info.outputs.version }}"
          Compress-Archive -Path dist/'NREGA Bot.exe' -DestinationPath dist/NREGABot-v$version-Windows-Portable.zip

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            installer/*.exe
            dist/NREGABot-v${{ needs.get-release-info.outputs.version }}-Windows-Portable.zip

  # --- Build Job for macOS ---
  build-macos:
    name: Build for macOS (Universal)
    needs: get-release-info
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Make build script executable
        run: chmod +x build_macos.sh

      - name: Run macOS build script
        run: ./build_macos.sh

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/NREGABot-v${{ needs.get-release-info.outputs.version }}-macOS.dmg

  # --- Build Job for Linux ---
  build-linux:
    name: Build for Linux (Portable)
    needs: get-release-info
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env

      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --windowed --onefile --name "NREGA Bot" \
          --icon="assets/app_icon.icns" \
          --add-data="logo.png:." \
          --add-data="theme.json:." \
          --add-data="changelog.json:." \
          --add-data="assets:assets" \
          --add-data=".env:." \
          --add-data="jobcard.jpeg:." \
          --add-data="tabs:tabs" \
          --collect-data fpdf \
          main_app.py

      - name: Create portable archive
        run: |
          cd dist
          tar -czvf NREGABot-v${{ needs.get-release-info.outputs.version }}-Linux.tar.gz "NREGA Bot"
          cd ..

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/NREGABot-v${{ needs.get-release-info.outputs.version }}-Linux.tar.gz

  # --- Publish Release ---
  publish-release:
    name: Publish GitHub Release
    needs: [get-release-info, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: NREGA Bot v${{ needs.get-release-info.outputs.version }}
          body: ${{ needs.get-release-info.outputs.changelog }}
          tag_name: v${{ needs.get-release-info.outputs.version }}
          files: |
            artifacts/windows-builds/**/*
            artifacts/macos-build/*
            artifacts/linux-build/*
